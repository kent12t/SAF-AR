import*as THREE from"three";import{FBXLoader}from"three/addons/loaders/FBXLoader.js";import{GLTFLoader}from"three/addons/loaders/GLTFLoader.js";import{OrbitControls}from"three/addons/controls/OrbitControls.js";import{MindARThree}from"mindar-image-three";const loadingElement=document.querySelector(".loading"),startButton=document.getElementById("startButton");let scene,camera,renderer,mindarThree=null,clock=new THREE.Clock,orbitControls=null,defaultCameraPosition=new THREE.Vector3(0,0,3),testMode=!1,audioContext=null,audioElement=null,audioSource=null,audioGainNode=null,audioFadeTimeout=null;function initAudio(){try{audioElement=new Audio("safra.mp3"),audioElement.loop=!1,audioContext=new(window.AudioContext||window.webkitAudioContext),audioSource=audioContext.createMediaElementSource(audioElement),audioGainNode=audioContext.createGain(),audioSource.connect(audioGainNode),audioGainNode.connect(audioContext.destination),console.log("Audio system initialized")}catch(e){console.error("Failed to initialize audio:",e)}}function playAudio(){if(audioElement&&audioContext)try{"suspended"===audioContext.state&&audioContext.resume(),audioGainNode.gain.value=1,audioFadeTimeout&&clearTimeout(audioFadeTimeout),audioElement.currentTime=0,audioElement.play().catch((e=>{console.error("Error playing audio:",e)})),console.log("Audio playback started")}catch(e){console.error("Error playing audio:",e)}}function fadeOutAudio(){if(audioElement&&audioContext&&audioGainNode)try{const e=50,t=1e3*2/e,o=1/t;let a=0;const i=setInterval((()=>{a++;const e=1-a*o;e<=0||a>=t?(audioGainNode.gain.value=0,clearInterval(i),setTimeout((()=>{audioElement.pause()}),100)):audioGainNode.gain.value=e}),e);console.log("Audio fade out started")}catch(e){console.error("Error fading audio:",e)}}function fixMaterial(e){if(e.isMeshPhongMaterial){const t=new THREE.MeshStandardMaterial;return t.map=e.map,t.color.copy(e.color),t.transparent=e.transparent,t.opacity=e.opacity,t.side=THREE.DoubleSide,t.roughness=.6,t.metalness=0,t.map&&(t.map.colorSpace=THREE.SRGBColorSpace,t.map.needsUpdate=!0),e.normalMap&&(t.normalMap=e.normalMap,t.normalScale.copy(e.normalScale)),t}return e.side=THREE.DoubleSide,e.transparent&&(e.opacity=1,e.alphaTest=.01,e.depthWrite=!0),e.map&&(e.map.colorSpace=THREE.SRGBColorSpace,e.map.needsUpdate=!0),e.normalMap&&(e.normalMap.needsUpdate=!0,e.normalScale.set(1,1)),e.needsUpdate=!0,e}function fixGeometry(e){return e.attributes.normal?(e.computeVertexNormals(),e.attributes.normal.needsUpdate=!0):e.computeVertexNormals(),e.attributes.position.needsUpdate=!0,e}window.addEventListener("resize",(()=>{if(renderer){const e=window.innerWidth,t=window.innerHeight;renderer.setSize(e,t),camera&&camera.aspect&&(camera.aspect=e/t,camera.updateProjectionMatrix())}}));const ModelManager={models:{},mixers:{},actions:{},cycleTimer:null,cycleInterval:18e3,async loadModel(e,t={}){const o={...{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:e.toLowerCase().endsWith(".glb")?1:.01,visible:!0,delay:0},...t};try{try{if(!(await fetch(e,{method:"HEAD"})).ok)throw console.error(`Model file not found: ${e}`),new Error(`Model file not found: ${e}`)}catch(t){throw console.error(`Error checking model file: ${e}`,t),new Error(`Cannot access model file: ${e}`)}let t,a=[];if(e.toLowerCase().endsWith(".fbx")){const o=new FBXLoader;t=await o.loadAsync(e),t.animations&&t.animations.length>0&&(a=t.animations)}else{if(!e.toLowerCase().endsWith(".glb")&&!e.toLowerCase().endsWith(".gltf"))throw new Error(`Unsupported model format: ${e}`);{const o=new GLTFLoader,i=await o.loadAsync(e);t=i.scene,i.animations&&i.animations.length>0&&(a=i.animations)}}if(t.position.set(o.position.x,o.position.y,o.position.z),t.rotation.set(o.rotation.x,o.rotation.y,o.rotation.z),t.scale.set(o.scale,o.scale,o.scale),e.includes("dis-ball")?t=applyWarmEmissiveMaterial(t):t.traverse((e=>{e.isMesh&&(e.material=fixMaterial(e.material),e.geometry&&(e.geometry=fixGeometry(e.geometry)))})),t.visible=o.visible,a.length>0){const o=new THREE.AnimationMixer(t);this.mixers[e]=o,a=this.fixAnimations(a,e);const i={};a.forEach(((e,t)=>{const a=e.name||`animation_${t}`,n=o.clipAction(e);n.loop=THREE.LoopOnce,n.clampWhenFinished=!0,n.paused=!0,n.play(),i[a]=n})),this.actions[e]=i,o.addEventListener("finished",(e=>{}))}return this.models[e]={object:t,options:o,animations:a},o.delay>0&&!o.visible&&this.showModel(e,o.delay),this.models[e]}catch(t){throw console.error(`Error loading model ${e}:`,t),t}},fixAnimations(e,t){return t.includes("ARMY AR")?e.map((e=>this.fixArmyAnimations(e))):e},fixArmyAnimations(e){const t=e.clone();for(let e=0;e<t.tracks.length;e++){t.tracks[e].name.includes("quaternion")}return t},updateAnimations(e){Object.keys(this.mixers).forEach((t=>{this.mixers[t].update(e)})),Object.keys(this.models).forEach((t=>{const o=this.models[t];o.object&&o.object.userData&&o.object.userData.update&&o.object.userData.update(e)}))},showModel(e,t=0){this.models[e]?!testMode&&mindarThree||setTimeout((()=>{this.models[e].object.visible=!0,this.actions[e]&&Object.keys(this.actions[e]).forEach((t=>{const o=this.actions[e][t];o.reset(),o.paused=!1,o.play()}))}),t):console.warn(`Cannot show model ${e}: not loaded`)},hideModel(e){this.models[e]?(this.models[e].object.visible=!1,this.actions[e]&&Object.keys(this.actions[e]).forEach((t=>{this.actions[e][t].paused=!0}))):console.warn(`Cannot hide model ${e}: not loaded`)},hideAllModels(){Object.keys(this.models).forEach((e=>{this.hideModel(e)}))},resetModels(){this.hideAllModels(),Object.keys(this.models).forEach((e=>{if(this.mixers[e]){this.mixers[e].stopAllAction();const t=this.models[e],o=new THREE.AnimationMixer(t.object);if(this.mixers[e]=o,t.animations&&t.animations.length>0){const a={};t.animations.forEach(((e,t)=>{const i=e.name||`animation_${t}`,n=o.clipAction(e);n.loop=THREE.LoopOnce,n.clampWhenFinished=!0,n.paused=!0,n.reset(),n.play(),a[i]=n})),this.actions[e]=a}}})),Object.keys(this.models).forEach((e=>{const{options:t}=this.models[e];this.showModel(e,t.delay)})),playAudio(),audioFadeTimeout&&clearTimeout(audioFadeTimeout),audioFadeTimeout=setTimeout((()=>{fadeOutAudio()}),this.cycleInterval-2e3)},startResetCycle(){this.cycleTimer&&clearInterval(this.cycleTimer),playAudio(),this.cycleTimer=setInterval((()=>{this.resetModels()}),this.cycleInterval);(()=>{audioFadeTimeout&&clearTimeout(audioFadeTimeout),audioFadeTimeout=setTimeout((()=>{fadeOutAudio()}),this.cycleInterval-2e3)})()},stopResetCycle(){this.cycleTimer&&(clearInterval(this.cycleTimer),this.cycleTimer=null),audioFadeTimeout&&(clearTimeout(audioFadeTimeout),audioFadeTimeout=null),audioElement&&audioElement.pause()},clearModels(){this.stopResetCycle(),Object.keys(this.mixers).forEach((e=>{delete this.mixers[e]})),this.actions={},this.models={}}},initTestScene=()=>{scene=new THREE.Scene,scene.background=new THREE.Color(0),camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3),renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,logarithmicDepthBuffer:!0}),renderer.setSize(window.innerWidth,window.innerHeight),renderer.setPixelRatio(window.devicePixelRatio),renderer.outputColorSpace=THREE.SRGBColorSpace,renderer.setClearColor(0,0),renderer.sortObjects=!0;const e=document.getElementById("ar-container");if(!e)return console.error("AR container element not found!"),null;e.appendChild(renderer.domElement);const t=new THREE.DirectionalLight(16777215,1);t.position.set(1,2,3),scene.add(t);const o=new THREE.AmbientLight(16777215,1);scene.add(o),camera.position.copy(defaultCameraPosition),orbitControls=new OrbitControls(camera,renderer.domElement),orbitControls.enableDamping=!0,orbitControls.dampingFactor=.05,orbitControls.screenSpacePanning=!1,orbitControls.minDistance=1,orbitControls.maxDistance=15,orbitControls.maxPolarAngle=Math.PI/1.5;const a=document.createElement("button");a.textContent="Reset Camera",a.style.position="absolute",a.style.bottom="20px",a.style.right="20px",a.style.zIndex="1000",a.style.padding="10px 15px",a.style.backgroundColor="#007bff",a.style.color="white",a.style.border="none",a.style.borderRadius="5px",a.style.cursor="pointer",a.style.fontWeight="bold",a.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",a.addEventListener("click",(()=>{const e=camera.position.clone(),t=camera.quaternion.clone(),o=new THREE.Quaternion,a=Date.now();!function i(){const n=Date.now()-a,r=Math.min(n/1e3,1),s=1-Math.pow(1-r,3);camera.position.lerpVectors(e,defaultCameraPosition,s),THREE.Quaternion.slerp(t,o,camera.quaternion,s),orbitControls.target.set(0,0,0),orbitControls.update(),r<1&&requestAnimationFrame(i)}()})),e.appendChild(a);const i=()=>{requestAnimationFrame(i),orbitControls&&orbitControls.update();const e=clock.getDelta();ModelManager.updateAnimations(e),renderer.render(scene,camera)};return i(),{scene:scene,camera:camera,renderer:renderer}},getModelConfigs=()=>[{id:"army",name:"Army AR",path:"models/army-ar.glb",position:{x:.5,y:0,z:-.8},scale:.3,delay:2e3,visible:!1,enabled:!0},{id:"civilian",name:"Civilian",path:"models/civilian.fbx",position:{x:0,y:0,z:0},scale:.003,delay:100,visible:!1,enabled:!0},{id:"rsaf",name:"RSAF AR",path:"models/rsaf.fbx",position:{x:-.5,y:0,z:-.5},scale:.003,delay:3500,visible:!1,enabled:!0},{id:"dis",name:"DIS AR",path:"models/dis.glb",position:{x:-1,y:0,z:-1},scale:.3,delay:6500,visible:!1,enabled:!0},{id:"ball",name:"DIS Ball",path:"models/dis-ball.fbx",position:{x:-1,y:.4,z:-.5},scale:.0021,delay:11e3,visible:!1,enabled:!0},{id:"navy",name:"Navy AR",path:"models/navy.fbx",position:{x:1,y:0,z:-.7},scale:.003,delay:5e3,visible:!1,enabled:!0}];function createSpotlightCylinder(e,t=1){const o=new THREE.CylinderGeometry(2,.5,8,16),a=new THREE.MeshStandardMaterial({emissive:new THREE.Color(16759722),emissiveIntensity:2,transparent:!0,opacity:.15,side:THREE.DoubleSide,depthWrite:!1}),i=new THREE.Mesh(o,a);return i.position.set(e.x,e.y+4.2,e.z+.2),i.rotation.x=Math.PI,i.visible=!1,i}const loadTestModels=async()=>{try{const e=getModelConfigs(),t=createTextBox(["Our NSmen","EVER READY","with our lives"],{x:0,y:2.5,z:-.75},!0);scene.add(t),t.visible=!0;const o=createTextBox(["Our sons, brothers, fathers, spouses, co-workers, friends","and neighbours—remarkable individuals bound by an","unwavering commitment to answer the call of duty to","defend our nation at any time"],{x:0,y:-1,z:-.75},!1);scene.add(o),o.visible=!0;const a=[];for(const t of e)if(t.enabled)try{const e=await ModelManager.loadModel(t.path,{position:t.position,scale:t.scale,visible:t.visible,delay:t.delay});if(e){if(scene.add(e.object),t.path.includes("dis-ball"))continue;const o=createSpotlightCylinder(t.position,t.path.includes("glb")?1.5:.8);scene.add(o),a.push({spotlight:o,delay:t.delay+500,modelPath:t.path})}}catch(e){console.error(`Failed to load model ${t.path}:`,e),displayErrorMessage(`Failed to load ${t.path}`)}a.forEach((({spotlight:e,delay:t,modelPath:o})=>{setTimeout((()=>{e.visible=!0}),t)})),ModelManager.startResetCycle();const i=ModelManager.resetModels;ModelManager.resetModels=function(){i.call(this),a.forEach((({spotlight:e})=>{e.visible=!1})),a.forEach((({spotlight:e,delay:t,modelPath:o})=>{setTimeout((()=>{e.visible=!0}),t)})),t&&(t.visible=!0),o&&(o.visible=!0)}}catch(e){console.error("Error loading test models:",e)}},initializeAR=async()=>{try{try{if(!(await fetch("targets/targets.mind",{method:"HEAD"})).ok)throw console.error("Target file does not exist or is not accessible"),new Error("Target file missing")}catch(e){throw console.error("Error checking target file:",e),new Error("Cannot access target file")}mindarThree=new MindARThree({container:document.querySelector("#ar-container"),imageTargetSrc:"targets/targets.mind",uiScanning:!0,uiLoading:!0,rendererOptions:{antialias:!0,alpha:!0,logarithmicDepthBuffer:!0,outputColorSpace:THREE.SRGBColorSpace,sortObjects:!0},filterMinCF:1e-4,filterBeta:.005,missTolerance:12,warmupTolerance:5,mirrorVideo:!0});const{renderer:e,scene:t,camera:o}=mindarThree;e.setClearColor(0,0);const a=mindarThree.addAnchor(0),i=new THREE.Group;i.position.set(0,0,0),i.scale.set(1,1,1),a.group.add(i);const n=new THREE.DirectionalLight(16777215,1);n.position.set(1,2,3),t.add(n);const r=new THREE.AmbientLight(16777215,1);t.add(r);const s=createTextBox(["Our NSmen","EVER READY","with our lives"],{x:0,y:2.5,z:.5},!0);i.add(s);const l=createTextBox(["Our sons, brothers, fathers, spouses, co-workers, friends","and neighbours—remarkable individuals bound by an","unwavering commitment to answer the call of duty to","defend our nation at any time"],{x:0,y:0,z:.5},!1);i.add(l);const d=[s,l],c=getModelConfigs(),m=[],u=[];let h=!1;for(const e of c)if(e.enabled)try{const t=await ModelManager.loadModel(e.path,{position:e.position,scale:e.scale,visible:!1,delay:e.delay});if(t){if(i.add(t.object),e.path.includes("dis-ball"))continue;const o=createSpotlightCylinder(e.position,e.path.includes("glb")?1.5:.8);i.add(o),m.push({spotlight:o,delay:e.delay,modelPath:e.path})}}catch(t){console.error(`Failed to load model ${e.path}:`,t),displayErrorMessage(`Failed to load ${e.path}`)}const p=()=>{h||(h=!0,playAudio(),audioFadeTimeout&&clearTimeout(audioFadeTimeout),audioFadeTimeout=setTimeout((()=>{fadeOutAudio()}),ModelManager.cycleInterval-2e3),u.forEach((e=>{clearTimeout(e)})),u.length=0,Object.keys(ModelManager.models).forEach((e=>{const t=ModelManager.models[e];t&&t.object&&(t.object.visible=!1,ModelManager.actions[e]&&Object.keys(ModelManager.actions[e]).forEach((t=>{const o=ModelManager.actions[e][t];o.paused=!0,o.reset()})))})),m.forEach((({spotlight:e})=>{e.visible=!1})),Object.keys(ModelManager.models).forEach((e=>{const t=ModelManager.models[e];if(!t||!t.object)return;const o=setTimeout((()=>{h&&(t.object.visible=!0,ModelManager.actions[e]&&Object.keys(ModelManager.actions[e]).forEach((t=>{const o=ModelManager.actions[e][t];o.reset(),o.play(),o.paused=!1})))}),t.options.delay);u.push(o)})),m.forEach((({spotlight:e,delay:t,modelPath:o})=>{const a=setTimeout((()=>{h&&(e.visible=!0)}),t);u.push(a)})))},E=()=>{h&&(h=!1,audioElement&&fadeOutAudio(),audioFadeTimeout&&(clearTimeout(audioFadeTimeout),audioFadeTimeout=null),u.forEach((e=>{clearTimeout(e)})),u.length=0,Object.keys(ModelManager.models).forEach((e=>{const t=ModelManager.models[e];t&&t.object&&(t.object.visible=!1,ModelManager.actions[e]&&Object.keys(ModelManager.actions[e]).forEach((t=>{const o=ModelManager.actions[e][t];o.paused=!0,o.reset()})))})),m.forEach((({spotlight:e,modelPath:t})=>{e.visible=!1})))};return a.onTargetFound=()=>{p(),d.forEach((e=>{e.visible=!0}))},a.onTargetLost=()=>{E(),d.forEach((e=>{e.visible=!1}))},e.setAnimationLoop((()=>{const a=clock.getDelta();ModelManager.updateAnimations(a),e.render(t,o)})),mindarThree.cleanup=()=>{E(),a.onTargetFound=null,a.onTargetLost=null},mindarThree}catch(e){throw console.error("Error initializing AR:",e),e}};function displayErrorMessage(e){const t=document.createElement("canvas");t.width=512,t.height=256;const o=t.getContext("2d");o.fillStyle="rgba(0, 0, 0, 0.8)",o.fillRect(0,0,t.width,t.height),o.font="24px Arial",o.fillStyle="white",o.textAlign="center",o.fillText("Error Loading Model:",t.width/2,100),o.fillText(e,t.width/2,140),o.fillText("Check console for details",t.width/2,180);const a=new THREE.CanvasTexture(t);a.colorSpace=THREE.SRGBColorSpace;const i=new THREE.PlaneGeometry(4,2),n=new THREE.MeshBasicMaterial({map:a,transparent:!0}),r=new THREE.Mesh(i,n);return scene.add(r),r}const startAR=async()=>{try{if(initAudio(),loadingElement&&(loadingElement.classList.remove("hidden"),document.querySelector(".loading-text").textContent="Loading 3D Models..."),renderer&&(renderer.dispose(),document.getElementById("ar-container").innerHTML=""),ModelManager.clearModels(),testMode){const e=initTestScene();if(!e)throw new Error("Failed to initialize test scene");const{scene:t,camera:o,renderer:a}=e;scene=t,camera=o,renderer=a,renderer.setClearColor(0,0),await loadTestModels()}else try{try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach((e=>e.stop()))}catch(e){throw console.error("Camera permission denied:",e),new Error("Camera permission denied. Please allow camera access to use AR mode.")}mindarThree=await initializeAR();try{await mindarThree.start()}catch(e){throw console.error("Error starting MindAR:",e),new Error("Failed to start camera. Please check camera permissions and try again.")}}catch(e){if(console.error("Error in AR mode:",e),loadingElement&&(document.querySelector(".loading-text").textContent=`Error: ${e.message||"Failed to initialize AR"}`),!confirm("AR mode failed. Would you like to try test mode instead?"))throw e;{testMode=!0;const e=initTestScene();if(!e)throw new Error("Failed to initialize fallback test scene");const{scene:t,camera:o,renderer:a}=e;scene=t,camera=o,renderer=a,await loadTestModels()}}loadingElement&&loadingElement.classList.add("hidden"),startButton&&(startButton.style.display="none");const e=document.querySelector(".control-panel");e&&(e.style.display="none")}catch(e){console.error("Error starting AR:",e),loadingElement&&loadingElement.classList.add("hidden"),alert(`Error starting experience: ${e.message||"Unknown error"}`),startButton&&(startButton.disabled=!1)}};window.addEventListener("load",(()=>{Promise.all([fetch("models/",{method:"HEAD"}).catch((()=>({ok:!1,status:404}))),fetch("targets/",{method:"HEAD"}).catch((()=>({ok:!1,status:404}))),fetch("js/main.js",{method:"HEAD"}).catch((()=>({ok:!1,status:404})))])}));const stopAR=async()=>{try{if(mindarThree&&!testMode&&("function"==typeof mindarThree.cleanup&&mindarThree.cleanup(),await mindarThree.stop(),mindarThree=null),ModelManager.stopResetCycle(),ModelManager.clearModels(),renderer){orbitControls&&(orbitControls.dispose(),orbitControls=null),renderer.dispose();const e=document.getElementById("ar-container");e&&(e.innerHTML=""),renderer=null}scene=null,camera=null,startButton&&(startButton.disabled=!1)}catch(e){console.error("Error stopping AR:",e),alert(`Error stopping experience: ${e.message||"Unknown error"}`)}};function applyWarmEmissiveMaterial(e){const t=new THREE.MeshStandardMaterial({color:new THREE.Color(16777215),emissive:new THREE.Color(16737792),emissiveIntensity:3,roughness:.3,side:THREE.DoubleSide});return e.traverse((e=>{e.isMesh&&(e.userData.originalMaterial=e.material,e.material=t)})),e}function createTextBox(e,t,o=!0){const a=new THREE.Group,i=o?2.4:3,n=o?1:.8,r=new THREE.PlaneGeometry(i,n),s=new THREE.MeshStandardMaterial({color:14540253,transparent:!0,opacity:.4,emissive:new THREE.Color(14540253),emissiveIntensity:2,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1}),l=new THREE.Mesh(r,s);a.add(l);const d=document.createElement("canvas"),c=d.getContext("2d");if(d.width=1024,d.height=512,c.fillStyle="rgba(0, 0, 0, 0)",c.fillRect(0,0,d.width,d.height),c.textAlign="center",o)c.fillStyle="#222222",c.font='48px "Arial Black", sans-serif',c.fillText(e[0],d.width/2,100),c.fillStyle="#222222",c.font='72px "Arial Black", sans-serif',c.fillText(e[1],d.width/2,180),c.fillStyle="#222222",c.font='48px "Arial Black", sans-serif',e[2]&&c.fillText(e[2],d.width/2,260);else{c.fillStyle="#222222",c.font="32px Arial, sans-serif";const t=800,o=36,a=e.join(" ").split(" ");let i="",n=100;for(let e=0;e<a.length;e++){const r=i+a[e]+" ";c.measureText(r).width>t&&e>0?(c.fillText(i,d.width/2,n),i=a[e]+" ",n+=o):i=r}c.fillText(i,d.width/2,n)}const m=new THREE.CanvasTexture(d);m.colorSpace=THREE.SRGBColorSpace,m.needsUpdate=!0;const u=new THREE.MeshBasicMaterial({map:m,transparent:!0,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1});let h,p;h=1*i,p=h/(d.width/d.height);const E=new THREE.Mesh(new THREE.PlaneGeometry(h,p),u);return E.position.z=.01,E.position.y=o?-.2:-.3,a.add(E),a.position.set(t.x,t.y,t.z),a.renderOrder=999,l.renderOrder=999,E.renderOrder=1e3,a.visible=!1,a}window.addEventListener("resize",(()=>{testMode&&renderer&&(camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight))})),startButton?startButton.addEventListener("click",startAR):console.warn("Start button not found, cannot attach event listener"),window.addEventListener("error",(e=>{console.error("Application error:",e),document.querySelector(".loading-text")&&(document.querySelector(".loading-text").textContent="Application error")}));